<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Using the SDCC compiler - Sduino</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="..">Sduino</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="..">Overview</a>
</li>

                        
                            
<li >
    <a href="../install/">Installation</a>
</li>

                        
                            
<li class="active">
    <a href="./">Using the SDCC compiler</a>
</li>

                        
                            
<li >
    <a href="../spl/">Using the SPL with SDCC and sduino</a>
</li>

                        
                            
<li >
    <a href="../macro/">C preprocessor macro magic</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Libraries <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../api/">API description and migration guidelines</a>
</li>

                        
                            
<li >
    <a href="../api/HardwareSerial/">HardwareSerial</a>
</li>

                        
                            
<li >
    <a href="../api/SPI/">SPI</a>
</li>

                        
                            
<li >
    <a href="../api/I2C/">I2C</a>
</li>

                        
                            
<li >
    <a href="../api/LiquidCrystal/">LiquidCrystal character LCD library</a>
</li>

                        
                            
<li >
    <a href="../api/PCD8544/">PCD8544 libray for Nokia 5110-like graphical LCDs</a>
</li>

                        
                            
<li >
    <a href="../api/Mini_SSD1306/">Mini_SSD1306 library for monochrome OLED-displays</a>
</li>

                        
                            
<li >
    <a href="../api/Stepper/">Stepper library</a>
</li>

                        
                            
<li >
    <a href="../api/Servo/">Servo library</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Hardware <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../flashtool/">Flash tool</a>
</li>

                        
                            
<li >
    <a href="../hardware/">List of supported boards</a>
</li>

                        
                            
<li >
    <a href="../pin_mapping/">Ways to define a pin mapping</a>
</li>

                        
                            
<li >
    <a href="../hardware/stm8blue/">Generic STM8S103 breakout board (stm8blue)</a>
</li>

                        
                            
<li >
    <a href="../hardware/esp14/">ESP14: Wifi board, STM8S003</a>
</li>

                        
                            
<li >
    <a href="../hardware/stm8sdiscovery/">STM8S105Discovery: Evaluation board made my ST</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../about/">About</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../install/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../spl/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#compiler">Compiler</a></li>
        
            <li><a href="#mixing-assembler-code-with-c-code">Mixing assembler code with C code</a></li>
        
            <li><a href="#notes-on-sdcc">Notes on SDCC</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h2 id="compiler">Compiler</h2>
<p>Tutorials:
http://www.cnx-software.com/2015/04/13/how-to-program-stm8s-1-board-in-linux/</p>
<p>STM8-Support only started with Version 3.4 in Ubuntu 14.10. For Ubuntu 14.4:</p>
<pre><code>add-apt-repository ppa:laczik/ppa
apt-get update
apt-get install sdcc
</code></pre>
<p>But even this version is fairly old and contains some known bugs. Better
download a current snapshot build from http://sdcc.sourceforge.net/ and
unpack it to <code>/opt/sdcc</code>. This requires a current version of libstdc++6:</p>
<pre><code>add-apt-repository ppa:ubuntu-toolchain-r/test
apt-get update
apt-get install libstdc++6
</code></pre>
<p>If you prefer to compile stm8flash yourself instead of using the Linux
binaries in the <code>tools</code> directory:</p>
<pre><code>git clone https://github.com/vdudouyt/stm8flash.git
cd stm8flash
make
sudo make install
</code></pre>
<p>Download some example code:</p>
<pre><code>git clone https://github.com/vdudouyt/sdcc-examples-stm8.git
cd sdcc-examples-stm8
</code></pre>
<p>The examples are meant for the STM8L, not the STM8S. This requires some
changes to account for the different pinout and register addresses (see below).
Finally upload the binary to the CPU:</p>
<pre><code>stm8flash -c stlinkv2 -p stm8s103?3 -w blinky.ihx
</code></pre>
<h3 id="mixing-assembler-code-with-c-code">Mixing assembler code with C code</h3>
<p>c-code:</p>
<pre><code>stacktest(0x1234, 0x5678);
</code></pre>
<p>assember:</p>
<pre><code>push    #0x78
push    #0x56
push    #0x34
push    #0x12
call    _stacktest
</code></pre>
<p>resulting stack content (starting at [SP], using simulator sstm8):</p>
<pre><code>0&gt; dch 0x17f9
0x017f9 c0 80 ab 12 34 56 78 5b ....4Vx[
</code></pre>
<p>=&gt; first paramter starts at [SP+3], MSB first.</p>
<h4 id="register-assignment">Register assignment</h4>
<p><strong>return values</strong>:
8 bit values in A, 16 bit values in X, 32 bit values in Y/X (Y=MSB, X=LSB)</p>
<p><strong>register preservation</strong>:
Not implemented for the STM8 (yet?). For some architectures SDCC implements
the possibility to mark a function that it does not effect the contents of
some registers:</p>
<pre><code>void f(void) __preserves_regs(b, c, iyl, iyh);
</code></pre>
<h3 id="notes-on-sdcc">Notes on SDCC</h3>
<p>The linker <code>sdld</code> does not automatically link the object file for main.c if it
is part of a library. It must be part of the list of object files. (Important
for the build process with Arduino.mk)</p>
<p>Befehl <code>__critical{..}</code> sollte eigentlich den vorherigen Interrupt-Zustand
wiederherstellen, es wird aber einfach ein festes Paar sim/rim produziert.
Mit "push cc; sim" und "pop cc" klappt es im Simulator, aber nicht in der
Realität.</p>
<p>Für jeden benutzten Interrupt <strong>muss</strong> ein Prototyp in der Datei stehen, in
der auch main() definiert ist. Aber für jeden Prototypen, für den es keine
Funktion gibt, ergibt einen Linkerfehler. Das erklärt den Sinn von stm8s_it.h
im Projektverzeichniss. Eine Arduino-ähnliche Umgebung muss diese Datei also
nach Analyse aller Sourcen selber erzeugen.</p>
<h4 id="simulator-sstm8">Simulator sstm8</h4>
<p>Does not account for different cpu models (work in progress).
base address for UART1 is 0x5240, not 0x5230
TX and RX interrupt vectors 0x804C and 0x8050.</p>
<p>Compilieren: braucht libboost-graph:
libboost-graph1.54-dev - generic graph components and algorithms in C++<br />
libboost-graph1.54.0 - generic graph components and algorithms in C++<br />
libboost-graph1.55-dev - generic graph components and algorithms in C++<br />
libboost-graph1.55.0 - generic graph components and algorithms in C++  </p>
<h4 id="missing-peephole-optimisations">Missing peephole optimisations</h4>
<p>Directly connected sequences of 'addw x,#' and 'subw x,#' should be
combined into one operation.</p>
<p>Multiplication by two is done by 'mul' instead of a bitshift. Important for
array access.</p>
<p><strong>Interrupt routine preamble</strong>:
Why is there a 'clr a/div x,a' sequence?</p>
<p><strong>Indirect 16 bit access</strong>:
'ldw x,#addr/ldw x,(x)' should be 'ldw x,[addr]'</p>
<p><strong>Indirect function call</strong>:
'ldw x,#addr/ldw x,(x)/call (x)' should be 'call [addr]'</p>
<p>Example (Interrupt routine calls a function from a jump table):</p>
<pre><code class="c">static volatile voidFuncPtr intFunc[EXTERNAL_NUM_INTERRUPTS] = {
    nothing,
    nothing,
};

void TIM1_CAP_COM_IRQHandler(void) __interrupt(ITC_IRQ_TIM1_CAPCOM)
{
    intFunc[1]();
}
</code></pre>

<pre><code class="asm">;   -----------------------------------------
;    function TIM1_CAP_COM_IRQHandler
;   -----------------------------------------
_TIM1_CAP_COM_IRQHandler:
    clr a
    div x, a
    ldw x, #_intFunc+2
    ldw x, (x)
    call    (x)
    iret
    .area CODE
    .area INITIALIZER
__xinit__intFunc:
    .dw _nothing
    .dw _nothing
    .area CABS (ABS)
</code></pre>

<h4 id="missing-compiler-features">Missing compiler features</h4>
<ul>
<li>_ _preserves_regs() function attribute not supported</li>
<li>_ <em>attribute</em> _((weak))</li>
<li>_ _critical{} generates sim/rim instead of push cc,sim/pop cc</li>
<li>dead code elimination: Does not recognize tables of const values. Using a
  const table would still pull in the whole object file, even when all
  accesses to the table have been eleminated by the optimizer. Only way out
  is to use <code>#define</code> statements instead.</li>
</ul></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
