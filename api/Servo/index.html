<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Servo library - Sduino</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Sduino</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../..">Overview</a>
</li>

                        
                            
<li >
    <a href="../../install/">Installation</a>
</li>

                        
                            
<li >
    <a href="../../sdcc/">Using the SDCC compiler</a>
</li>

                        
                            
<li >
    <a href="../../spl/">Using the SPL with SDCC and sduino</a>
</li>

                        
                            
<li >
    <a href="../../macro/">C preprocessor macro magic</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Libraries <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../">API description and migration guidelines</a>
</li>

                        
                            
<li >
    <a href="../HardwareSerial/">HardwareSerial</a>
</li>

                        
                            
<li >
    <a href="../SPI/">SPI</a>
</li>

                        
                            
<li >
    <a href="../I2C/">I2C</a>
</li>

                        
                            
<li >
    <a href="../LiquidCrystal/">LiquidCrystal character LCD library</a>
</li>

                        
                            
<li >
    <a href="../PCD8544/">PCD8544 libray for Nokia 5110-like graphical LCDs</a>
</li>

                        
                            
<li >
    <a href="../Mini_SSD1306/">Mini_SSD1306 library for monochrome OLED-displays</a>
</li>

                        
                            
<li >
    <a href="../Stepper/">Stepper library</a>
</li>

                        
                            
<li class="active">
    <a href="./">Servo library</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Hardware <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../flashtool/">Flash tool</a>
</li>

                        
                            
<li >
    <a href="../../hardware/">List of supported boards</a>
</li>

                        
                            
<li >
    <a href="../../pin_mapping/">Ways to define a pin mapping</a>
</li>

                        
                            
<li >
    <a href="../../hardware/stm8blue/">Generic STM8S103 breakout board (stm8blue)</a>
</li>

                        
                            
<li >
    <a href="../../hardware/esp14/">ESP14: Wifi board, STM8S003</a>
</li>

                        
                            
<li >
    <a href="../../hardware/stm8sdiscovery/">STM8S105Discovery: Evaluation board made my ST</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../about/">About</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../Stepper/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../../flashtool/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#servo-library">Servo Library</a></li>
        
            <li><a href="#example">Example</a></li>
        
            <li><a href="#api">API</a></li>
        
            <li><a href="#relationship-between-pwmanalog-output-and-servo-output">Relationship between PWM/analog output and Servo output</a></li>
        
            <li><a href="#possible-improvements">Possible improvements</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="servo-library">Servo Library</h1>
<p>This library can control a great number of servos. It makes careful use
of timers: the library can control 12 servos using only 1 timer.
Derived from the Arduino Servo library v1.8.0.</p>
<p>This library has a slightly diffent user interface than the usual singleton
libraries. This allows for handling more than one servo per Sketch but it
requires some more attention when porting an existing sketch from C++ to C.</p>
<p>Each Servo instance is identified by a channel-ID. In order to match the C++
class constructor syntax it is defined as a type <code>Servo</code>.</p>
<p>This channel-ID is used as a file-descriptor-like value and need to be
passed to all API functions except for <code>Servo_attach()</code>. This function
claimes the next free channel number.</p>
<h2 id="example">Example</h2>
<p>Read a potentiometer on analog input 0 and set a servo pulse length between
1000us and 2023us:</p>
<pre><code class="c">#include &lt;Arduino.h&gt;
#include &lt;Servo.h&gt;

Servo myservo;          // just a simple unsigned char to hold the channel-ID

int val;                // variable to read the value from the analog pin

void setup() {
  myservo = Servo_attach(9);    // attaches the servo on pin 9, returns channel-ID
}

void loop() {
  val = analogRead(0);          // reads the value of the potentiometer
  Servo_write(myservo, val+1000);// sets the servo position
  delay(15);
}
</code></pre>

<p>Original Arduino C++-Sytax:</p>
<pre><code class="c">#include &lt;Servo.h&gt;

Servo myservo;          // create servo object to control a servo

int val;                // variable to read the value from the analog pin

void setup() {
  myservo.attach(9);    // attaches the servo on pin 9 to the servo object
}

void loop() {
  val = analogRead(0);          // reads the value of the potentiometer
  myservo.write(val+1000);      // sets the servo position
  delay(15);
}

</code></pre>

<h2 id="api">API</h2>
<p>data type <code>Servo</code>: A type definition for a simple unsigned char to hold the
channel number returned my <code>Servo_attach()</code>. Needed for every servo. Syntax
identical to the Arduino class constructor.</p>
<table>
<thead>
<tr>
<th>Arduino syntax</th>
<th>sduino syntax</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Servo myservo;</code></td>
<td><code>Servo myservo;</code></td>
</tr>
<tr>
<td><code>myservo.attach(pin);</code></td>
<td><code>myservo = Servo_attach(pin);</code></td>
</tr>
<tr>
<td><code>myservo.attach(pin,min,max);</code></td>
<td><code>Servo_attach_minmax(pin,min,max);</code></td>
</tr>
<tr>
<td><code>myservo.detach();</code></td>
<td><code>Servo_detach(byte channel);</code></td>
</tr>
<tr>
<td><code>myservo.write(val);</code></td>
<td><code>Servo_write(myservo, val);</code></td>
</tr>
<tr>
<td><code>myservo.writeMicroseconds(val);</code></td>
<td><code>Servo_writeMicroseconds(myservo, val);</code></td>
</tr>
<tr>
<td><code>val = myservo.read();</code></td>
<td><code>val = Servo_read(myservo);</code></td>
</tr>
<tr>
<td><code>val = myservo.readMicroseconds();</code></td>
<td><code>val = Servo_readMicroseconds(myservo);</code></td>
</tr>
<tr>
<td><code>myservo.attached()</code></td>
<td><code>Servo_attached(myservo);</code></td>
</tr>
</tbody>
</table>
<p><code>uint8_t Servo_attach(int pin);</code>
attach the given pin to the next free channel, sets pinMode, returns channel
number or 0 if failure.</p>
<p><code>uint8_t Servo_attach_minmax(int pin, int min, int max);</code>
as above but also sets min and max values for writes. </p>
<p><code>void Servo_detach(byte channel);</code></p>
<p><code>void Servo_write(byte channel, int value);</code> if value is &lt; 200 it is treated
as an angle and scaled according the minimum and maximum pulsewidth defined
using the attach() function earlier, otherwise as pulse width in
microseconds, unscaled.</p>
<p><code>void Servo_writeMicroseconds(byte channel, int value);</code>
Write pulse width in microseconds, unscaled.</p>
<p><code>int Servo_read(byte channel);</code>
returns current pulse width as an angle between 0 and 180 degrees.</p>
<p><code>int Servo_readMicroseconds(byte channel);</code>
returns current pulse width in microseconds for this servo (was read_us() in
first Arduino release).</p>
<p><code>bool Servo_attached(byte channel);</code>
return true if this servo is attached, otherwise false .</p>
<h2 id="relationship-between-pwmanalog-output-and-servo-output">Relationship between PWM/analog output and Servo output</h2>
<p>It is not possible to use a timer for PWM and the Servo Library at the same
time. Since this library currently uses timer1, the PWM function
(<code>analogWrite()</code>) is disabled for the pins connected to timer1 (for the
STM8S103 this is pin PC3 and PC4 or digital pin 5 and 6).</p>
<p>Pins connected to timer2 (PA3, PD3, PD4, digital pin 2,12,13) are still
usable for PWM output.</p>
<h2 id="possible-improvements">Possible improvements</h2>
<h3 id="a-more-sophisticated-pseudo-oo-api">A more sophisticated pseudo-OO API</h3>
<p>Define a set of preprocessor macros that more OO-like definitions like this
become possible:</p>
<table>
<thead>
<tr>
<th>Current syntax</th>
<th>OO-like syntax</th>
<th>Arduino syntax</th>
</tr>
</thead>
<tbody>
<tr>
<td>myservo = Servo_attach(pin);</td>
<td>myservo_attach(pin);</td>
<td>myservo.attach(pin);</td>
</tr>
<tr>
<td>Servo_write(myservo, val);</td>
<td>myservo_write(val);</td>
<td>myservo_write(val);</td>
</tr>
<tr>
<td>val = Servo_read(myservo);</td>
<td>val = myservo_read();</td>
<td>val = myservo_read();</td>
</tr>
</tbody>
</table>
<h3 id="optimizing-the-handle_interrupts-function">Optimizing the handle_interrupts() function</h3>
<p>SDCC compiles this function very inefficiently. The code size is around 500
Bytes, and it is executed as part of the CC interrupt routine. Expected CPU
load for a full servo group of 12 servos is approx. 2%.</p>
<p>(Calculated for 16MHz CPU clock, 13 interrupts every 20ms = 650
interrupts/sec, approx. 500 clock cycles each)</p>
<h3 id="using-more-than-one-cc-channel-per-timer">Using more than one CC channel per timer</h3>
<p>it might be possible to use all capture+compare (CC) channels of one timer
at the same time, attaching one servo group to each CC-channel. This way it
would be possible to serve up to 48 servos using the four CC-channels of
timer TIM1. Monitoring the repetion period might become a little complex, as
it must be ensured that all servos on all channels have finshed before.</p></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
